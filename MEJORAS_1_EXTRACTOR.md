# üöÄ Mejoras Implementadas en 1_extractor.py

**Fecha:** 13 de octubre de 2025
**Versi√≥n:** 2.0

---

## ‚úÖ Todas las Mejoras Solicitadas Implementadas

### 1. ‚úÖ Carpeta `backups/` Creada

Todos los archivos de respaldo ahora est√°n organizados en la carpeta `backups/`:

```
backups/
‚îú‚îÄ‚îÄ 1_extractor_backup.py
‚îú‚îÄ‚îÄ 1_extractor_original.py
‚îú‚îÄ‚îÄ 3_insercion_backup.py
‚îî‚îÄ‚îÄ 4_visualizacion_backup.py
```

---

### 2. ‚úÖ Par√°metro para Procesar Archivos Completos (Sin N√∫mero Extenso)

**Antes:**
```python
max_records = 300000  # N√∫mero fijo y extenso
```

**Ahora:**
```python
# Por defecto: Procesa archivos COMPLETOS (max_registros = None)
python 1_extractor.py              # Procesa TODOS los registros sin l√≠mite
python 1_extractor.py --full       # Expl√≠citamente procesa completos
python 1_extractor.py --limit 5000 # Limita si es necesario
```

**Ventajas:**
- ‚úÖ Modo por defecto: Extrae TODOS los registros
- ‚úÖ Sin n√∫meros extensos como 90000000
- ‚úÖ Mensaje claro: "Extrayendo TODOS los registros (123,456)"
- ‚úÖ Flexible: Puedes limitar si necesitas probar con menos datos

---

### 3. ‚úÖ Sistema de Tracking para Evitar Reprocesamiento

**Archivo de tracking:** `datos_raw/.processed_files.txt`

**C√≥mo funciona:**
1. Cada vez que un archivo es procesado exitosamente, se registra su:
   - Ruta completa
   - Hash MD5 (para detectar si cambi√≥)

2. En ejecuciones futuras:
   - ‚úÖ Archivos ya procesados se omiten autom√°ticamente
   - ‚ö†Ô∏è  Si un archivo cambi√≥ (hash diferente), se reprocesa
   - üîÑ Opci√≥n `--force` permite reprocesar todos

**Ejemplo del archivo de tracking:**
```
data-cruda/Agosto/Agosto_BM_2025.xlsx|a3f5e8c9d1b2...
data-cruda/Agosto/Agosto_BV_2025.xlsx|b4f6e9c0d2b3...
data-cruda/Septiembre/Septiembre_BM_2025.xlsx|c5f7e0c1d3b4...
```

**Salida del script:**
```
üìù Archivos previamente procesados: 6

üè¶ Banco M√≥vil - Agosto
   ‚è≠Ô∏è  Omitiendo: Agosto_BM_2025.xlsx (ya procesado)

üè¶ Banco M√≥vil - Septiembre
   üìÇ Procesando: data-cruda/Septiembre/Septiembre_BM_2025.xlsx
   ...
```

---

### 4. ‚úÖ Opci√≥n para Procesar Solo un Archivo Espec√≠fico

**Comando:**
```bash
python 1_extractor.py --file "Agosto_BM_2025.xlsx"
```

**Qu√© hace:**
- Solo procesa el archivo especificado
- Ignora todos los dem√°s archivos
- √ötil para:
  - Corregir problemas con un archivo espec√≠fico
  - Reprocesar un solo mes
  - Pruebas y debugging

**Ejemplo de uso:**
```bash
# Problema detectado en archivo de Septiembre BM
python 1_extractor.py --file "Septiembre_BM_2025.xlsx" --force

# Output:
üìÑ Procesando solo: Septiembre_BM_2025.xlsx

üè¶ Banco M√≥vil - Septiembre
   üìÇ Procesando: data-cruda/Septiembre/Septiembre_BM_2025.xlsx
   ...
```

---

### 5. ‚úÖ Log Individual (.txt) por Cada Archivo Procesado

**Para cada archivo Excel procesado, se genera un archivo .txt con informaci√≥n detallada:**

**Ejemplo:** `datos_raw/Agosto_BM_2025_extracted_50000.txt`

```
================================================================================
LOG DE EXTRACCI√ìN - 1_extractor.py
================================================================================

Fecha de extracci√≥n: 2025-10-13 14:32:15
Archivo original: Agosto_BM_2025.xlsx
Archivo de salida: Agosto_BM_2025_extracted_50000.xlsx
Tipo de archivo: BM

ESTAD√çSTICAS:
  - Total registros en archivo original: 50,234
  - Registros extra√≠dos: 50,000
  - Total columnas: 15

COLUMNAS CLAVE DETECTADAS:
  ‚Ä¢ timestamp
  ‚Ä¢ answerDate
  ‚Ä¢ answers
  ‚Ä¢ nps_score
  ‚Ä¢ feedbackType

ADVERTENCIAS:
  ‚ö†Ô∏è  Archivo limitado a 50,000 registros
  ‚ö†Ô∏è  Encoding UTF-8 malformado detectado en columna 'answers'

ESTADO: ‚úÖ Exitoso
================================================================================
```

**Ubicaci√≥n de logs:**
- **Individual por archivo:** `datos_raw/[nombre_archivo].txt`
- **Log general del script:** `extraccion_datos.log`

**Ventajas:**
- ‚úÖ Historial completo de cada extracci√≥n
- ‚úÖ Detecci√≥n de problemas espec√≠ficos por archivo
- ‚úÖ Informaci√≥n √∫til para debugging
- ‚úÖ Trazabilidad completa

---

### 6. ‚úÖ Log General Mejorado

**Archivo:** `extraccion_datos.log`

**Contenido:**
```
2025-10-13 14:32:10 - INFO - Iniciando extracci√≥n - Modo: COMPLETO (sin l√≠mite)
2025-10-13 14:32:10 - INFO - Archivos en tracking: 4
2025-10-13 14:32:10 - INFO - Escaneando directorio: data-cruda
2025-10-13 14:32:10 - INFO - Encontrado BM: data-cruda/Agosto/Agosto_BM_2025.xlsx
2025-10-13 14:32:10 - INFO - Omitido (ya procesado): data-cruda/Agosto/Agosto_BM_2025.xlsx
2025-10-13 14:32:15 - INFO - Iniciando extracci√≥n: data-cruda/Septiembre/Septiembre_BM_2025.xlsx
2025-10-13 14:32:45 - INFO - üìÑ Log individual generado: Septiembre_BM_2025_extracted_52000.txt
2025-10-13 14:32:45 - INFO - Extracci√≥n exitosa: datos_raw/Septiembre_BM_2025_extracted_52000.xlsx (52,000 registros)
2025-10-13 14:32:45 - INFO - üìù Archivo registrado en tracking: Septiembre_BM_2025.xlsx
2025-10-13 14:33:00 - INFO - Extracci√≥n completada: 1 archivos, 52,000 registros
```

---

## üìã Opciones de L√≠nea de Comandos

### Todas las Opciones Disponibles:

```bash
# 1. Modo por defecto (procesa archivos nuevos completos)
python 1_extractor.py

# 2. Procesar archivos completos expl√≠citamente
python 1_extractor.py --full

# 3. Limitar registros para pruebas
python 1_extractor.py --limit 5000

# 4. Procesar solo un archivo espec√≠fico
python 1_extractor.py --file "Agosto_BM_2025.xlsx"

# 5. Forzar reprocesamiento de todos (ignorar tracking)
python 1_extractor.py --force

# 6. Combinar opciones
python 1_extractor.py --file "Septiembre_BM_2025.xlsx" --limit 1000 --force
```

### Ayuda del Script:

```bash
python 1_extractor.py --help

usage: 1_extractor.py [-h] [--full] [--limit LIMIT] [--file FILE] [--force]

Extractor de Datos NPS - Pipeline de Producci√≥n

optional arguments:
  -h, --help      show this help message and exit
  --full          Procesar archivos completos sin l√≠mite de registros
  --limit LIMIT   N√∫mero m√°ximo de registros a extraer por archivo
  --file FILE     Nombre espec√≠fico de archivo a procesar (ej: Agosto_BM_2025.xlsx)
  --force         Forzar reprocesamiento de archivos ya procesados

Ejemplos de uso:
  python 1_extractor.py                              # Procesa archivos nuevos
  python 1_extractor.py --full                       # Procesa archivos completos
  python 1_extractor.py --limit 5000                 # Limita a 5000 registros
  python 1_extractor.py --file "Agosto_BM_2025.xlsx" # Solo un archivo
  python 1_extractor.py --force                      # Fuerza reprocesamiento
```

---

## üéØ Flujo de Trabajo T√≠pico

### Primera Ejecuci√≥n (Archivos Nuevos):

```bash
python 1_extractor.py

# Output:
üöÄ EXTRACTOR DE DATOS NPS - PIPELINE DE PRODUCCI√ìN
‚öôÔ∏è  MODO: COMPLETO (sin l√≠mite)

üìù Archivos previamente procesados: 0

üîç Escaneando directorio: data-cruda

üìÅ Escaneando mes: Agosto
   ‚úÖ Banco M√≥vil (BM): Agosto_BM_2025.xlsx
   ‚úÖ Banco Virtual (BV): Agosto_BV_2025.xlsx

================================================================================
üìÖ PROCESANDO MES: Agosto
================================================================================

üè¶ Banco M√≥vil - Agosto

üìÇ Procesando: data-cruda/Agosto/Agosto_BM_2025.xlsx
   ‚è≥ Leyendo archivo Excel...
   üìä Total de registros en archivo: 50,234
   üìã Columnas disponibles: 15
   ‚ÑπÔ∏è  Extrayendo TODOS los registros (50,234)
   üíæ Guardando datos extra√≠dos...
   ‚úÖ Datos guardados: datos_raw/Agosto_BM_2025_extracted_50234.xlsx
   üìà Registros extra√≠dos: 50,234

   üìä COLUMNAS CLAVE DETECTADAS:
      ‚Ä¢ timestamp
      ‚Ä¢ answerDate
      ‚Ä¢ answers

üìÑ Log individual generado: Agosto_BM_2025_extracted_50234.txt
üìù Archivo registrado en tracking: Agosto_BM_2025.xlsx

üíª Banco Virtual - Agosto
...

================================================================================
üìä RESUMEN DE EXTRACCI√ìN
================================================================================

‚úÖ ARCHIVOS PROCESADOS EXITOSAMENTE (2):

   BM - Agosto:
      Original: Agosto_BM_2025.xlsx
      Extra√≠do: Agosto_BM_2025_extracted_50234.xlsx
      Registros: 50,234

   BV - Agosto:
      Original: Agosto_BV_2025.xlsx
      Extra√≠do: Agosto_BV_2025_extracted_234.xlsx
      Registros: 234

üìà TOTAL: 2 archivos procesados, 50,468 registros extra√≠dos

üéØ PR√ìXIMOS PASOS:
   1. Revisar logs individuales (.txt) en 'datos_raw/'
   2. python 2_limpieza.py      # Limpiar y transformar datos
   3. python 3_insercion.py     # Insertar en PostgreSQL
   4. python 4_visualizacion.py # Generar dashboard

üìù Archivo de tracking actualizado: datos_raw/.processed_files.txt
   Total de archivos registrados: 2
```

### Segunda Ejecuci√≥n (Archivos Ya Procesados):

```bash
python 1_extractor.py

# Output:
üöÄ EXTRACTOR DE DATOS NPS - PIPELINE DE PRODUCCI√ìN
‚öôÔ∏è  MODO: COMPLETO (sin l√≠mite)

üìù Archivos previamente procesados: 2

üîç Escaneando directorio: data-cruda

üìÅ Escaneando mes: Agosto
   ‚úÖ Banco M√≥vil (BM): Agosto_BM_2025.xlsx
   ‚úÖ Banco Virtual (BV): Agosto_BV_2025.xlsx

================================================================================
üìÖ PROCESANDO MES: Agosto
================================================================================

üè¶ Banco M√≥vil - Agosto
   ‚è≠Ô∏è  Omitiendo: Agosto_BM_2025.xlsx (ya procesado)

üíª Banco Virtual - Agosto
   ‚è≠Ô∏è  Omitiendo: Agosto_BV_2025.xlsx (ya procesado)

================================================================================
üìä RESUMEN DE EXTRACCI√ìN
================================================================================

‚è≠Ô∏è  ARCHIVOS OMITIDOS (ya procesados): 2
   ‚Ä¢ BM - Agosto: Agosto_BM_2025.xlsx
   ‚Ä¢ BV - Agosto: Agosto_BV_2025.xlsx
```

### Reprocesar un Archivo Modificado:

```bash
# El archivo Agosto_BM_2025.xlsx fue modificado/actualizado
python 1_extractor.py

# Output:
‚ö†Ô∏è  Archivo modificado detectado: Agosto_BM_2025.xlsx

üè¶ Banco M√≥vil - Agosto
üìÇ Procesando: data-cruda/Agosto/Agosto_BM_2025.xlsx
   ...
```

---

## üìä Archivos Generados

### Estructura de `datos_raw/` Despu√©s de Extracci√≥n:

```
datos_raw/
‚îú‚îÄ‚îÄ .processed_files.txt                      ‚Üê Tracking de archivos procesados
‚îÇ
‚îú‚îÄ‚îÄ Agosto_BM_2025_extracted_50234.xlsx      ‚Üê Datos extra√≠dos
‚îú‚îÄ‚îÄ Agosto_BM_2025_extracted_50234.txt       ‚Üê Log individual
‚îÇ
‚îú‚îÄ‚îÄ Agosto_BV_2025_extracted_234.xlsx
‚îú‚îÄ‚îÄ Agosto_BV_2025_extracted_234.txt
‚îÇ
‚îú‚îÄ‚îÄ Septiembre_BM_2025_extracted_52100.xlsx
‚îú‚îÄ‚îÄ Septiembre_BM_2025_extracted_52100.txt
‚îÇ
‚îî‚îÄ‚îÄ Septiembre_BV_2025_extracted_198.xlsx
    Septiembre_BV_2025_extracted_198.txt
```

---

## üîç Comparaci√≥n: Antes vs Ahora

| Aspecto | Antes | Ahora |
|---------|-------|-------|
| **L√≠mite de registros** | N√∫mero fijo (300,000) | `--full` (sin l√≠mite) o `--limit N` |
| **Reprocesamiento** | Siempre reprocesa todo | Sistema de tracking evita reprocesar |
| **Archivo espec√≠fico** | No disponible | `--file "nombre.xlsx"` |
| **Logs individuales** | Solo log general | `.txt` por cada archivo + log general |
| **Detecci√≥n de cambios** | No detecta | Hash MD5 detecta archivos modificados |
| **Forzar reproceso** | No disponible | `--force` flag |
| **Backups** | Dispersos | Carpeta `backups/` organizada |

---

## ‚úÖ Checklist de Implementaci√≥n

- [x] ‚úÖ Par√°metro `--full` para procesar archivos completos
- [x] ‚úÖ Par√°metro `--limit N` para limitar registros
- [x] ‚úÖ Sistema de tracking con `.processed_files.txt`
- [x] ‚úÖ Hash MD5 para detectar archivos modificados
- [x] ‚úÖ Opci√≥n `--file` para procesar archivo espec√≠fico
- [x] ‚úÖ Opci√≥n `--force` para reprocesar todos
- [x] ‚úÖ Log individual `.txt` por cada archivo procesado
- [x] ‚úÖ Log general mejorado `extraccion_datos.log`
- [x] ‚úÖ Carpeta `backups/` para archivos de respaldo
- [x] ‚úÖ Formato de salida optimizado para `2_limpieza.py`

---

## üéì Documentaci√≥n Adicional

### Variables de Configuraci√≥n:

```python
# En 1_extractor.py (l√≠neas 76-85)
DIRECTORIO_ENTRADA = "data-cruda"           # Archivos Excel originales
DIRECTORIO_SALIDA = "datos_raw"             # Datos extra√≠dos
ARCHIVO_TRACKING = ".processed_files.txt"   # Tracking
LOG_GENERAL = "extraccion_datos.log"        # Log general
```

### Funciones Principales:

1. `obtener_hash_archivo()` - Genera hash MD5 del archivo
2. `cargar_archivos_procesados()` - Lee archivo de tracking
3. `registrar_archivo_procesado()` - Actualiza tracking
4. `archivo_ya_procesado()` - Verifica si debe omitir
5. `generar_log_individual()` - Crea archivo .txt con info
6. `extraer_datos()` - Extrae datos del Excel
7. `buscar_archivos_datos()` - Escanea directorios

---

## üöÄ Ventajas de las Mejoras

### Para el Usuario:
- ‚úÖ **No reprocesa archivos innecesariamente** (ahorra tiempo)
- ‚úÖ **Logs detallados por archivo** (f√°cil debugging)
- ‚úÖ **Procesamiento selectivo** (repara problemas espec√≠ficos)
- ‚úÖ **Detecci√≥n autom√°tica de cambios** (seguridad)

### Para el Sistema:
- ‚úÖ **Eficiencia mejorada** (solo procesa lo nuevo)
- ‚úÖ **Trazabilidad completa** (logs individuales + tracking)
- ‚úÖ **Flexibilidad** (m√∫ltiples opciones de ejecuci√≥n)
- ‚úÖ **Robustez** (detecci√≥n de archivos modificados)

---

**Autor:** Claude Code
**Fecha:** 13 de octubre de 2025
**Versi√≥n:** 2.0
**Estado:** ‚úÖ Completado
